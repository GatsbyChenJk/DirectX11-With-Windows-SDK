# 天空盒的绘制

### 方法1：使用教程项目中的应用程序DXTex构建天空盒纹理

打开软件后先依次点击左上角File-> New Texture后会弹出以下界面

![img](https://img2018.cnblogs.com/blog/1172605/201905/1172605-20190510184545519-1493245227.png)

将参数按红色框中方式设置，然后点击OK

创建好后会变成这样：
![img](https://img2018.cnblogs.com/blog/1172605/201810/1172605-20181028164915275-161779832.png)

可以看到当前默认的是+X纹理。

接下来就是将这六张图片塞进该立方体纹理中了，选择View-Cube map Face，并选择需要修改的纹理：
![img](https://img2018.cnblogs.com/blog/1172605/201810/1172605-20181028164941402-1885864769.png)

在当前项目的Texture文件夹内已经准备好了有6张贴图。
![img](https://img2018.cnblogs.com/blog/1172605/201810/1172605-20181028164954733-588436585.png)

选择File-Open To This Cubemap Face来选择对应的贴图以加载进来即可。每完成当前的面就要切换到下一个面继续操作，直到六个面都填充完毕。此时填充的是Mipmap Level为0的子资源：

![img](https://img2018.cnblogs.com/blog/1172605/201810/1172605-20181028174344999-437426852.png)

如果你需要自动生成纹理，则可以点击下面的选项生成，要求创建时MipMap Level为1：

![img](https://img2018.cnblogs.com/blog/1172605/201905/1172605-20190510184833647-1723891017.png)

最后就可以点击File-Save As来保存dds文件了。

### 方法2：代码构建纹理

以教程项目22其中的DayLight天空盒作为例子说明

将一张天空盒贴图转化成立方体纹理需要经历以下4个步骤：

1. 读取6张图片数据到CPU，或者创建GPU资源
2. 创建包含6个纹理的数组，本例中为pCubeTextures
3. 每个图片拷贝到纹理数组的对应位置（`UpdateSubresource`或`CopySubresourceRegion`）
4. 创建立方体纹理的SRV

具体代码如下：

```cpp
ComPtr<ID3D11Texture2D> pTex;
D3D11_TEXTURE2D_DESC texDesc;
std::string filenameStr;
std::vector<ID3D11ShaderResourceView*> pCubeTextures;
std::unique_ptr<TextureCube> pTexCube;
// Daylight
// 读取图片数据
{
    filenameStr = "..\\Texture\\daylight0.png";
    for (size_t i = 0; i < 6; ++i)
    {
        filenameStr[19] = '0' + (char)i;
        pCubeTextures.push_back(m_TextureManager.CreateTexture(filenameStr));
    }

    pCubeTextures[0]->GetResource(reinterpret_cast<ID3D11Resource**>(pTex.ReleaseAndGetAddressOf()));
    pTex->GetDesc(&texDesc);
    pTexCube = std::make_unique<TextureCube>(m_pd3dDevice.Get(), texDesc.Width, texDesc.Height, DXGI_FORMAT_R8G8B8A8_UNORM_SRGB);
    for (uint32_t i = 0; i < 6; ++i)
    {
        pCubeTextures[i]->GetResource(reinterpret_cast<ID3D11Resource**>(pTex.ReleaseAndGetAddressOf()));
        m_pd3dImmediateContext->CopySubresourceRegion(pTexCube->GetTexture(), 
            D3D11CalcSubresource(0, i, 1), 0, 0, 0, pTex.Get(), 0, nullptr);
    }
    m_TextureManager.AddTexture("Daylight", pTexCube->GetShaderResource());
}
```

`TextureManager::CreateTexture`可以创建出GPU纹理资源，然后复制过去就行了。在创建了纹理立方体后，我们可以在GameApp::InitResource函数中将纹理立方体绑定到新创建的立方体模型上：

```cpp
// 天空盒立方体
Model* pModel = m_ModelManager.CreateFromGeometry("Skybox", Geometry::CreateBox());
pModel->materials[0].Set<std::string>("$Skybox", "Daylight");
m_Skybox.SetModel(pModel);
```

在`SkyboxEffect`里定义了`$Skybox`建立和着色器中纹理立方体的对应关系。现在我们将`$Skybox`映射为`TextureManager`中的`Daylight`纹理，后面在绘制的时候`SkyboxEffect`就会去查找该纹理并绑定到管线上。

`SkyboxEffect`的代码比较简单，读者可以自行阅读源码部分。

# 基于方法一创建的天空盒纹理

首先我用六个图片文件创建了一个天空盒纹理，保存为dds文件，这里我命名为TextSkybox。

![image-20230415164957261](C:\Users\25768\AppData\Roaming\Typora\typora-user-images\image-20230415164957261.png)

**注意：要将文件放入项目路径中的Texture文件夹**

在GameApp::InitResource中初始化天空盒纹理

```cpp
// TextSkybox
    m_TextureManager.AddTexture("Text", m_TextureManager.CreateFromFile("..\\Texture\\TextSkybox.dds", false, true));
```

接着在GameApp::UpdateScene中修改如下：

```cpp
void GameApp::UpdateScene(float dt)
{
    m_CameraController.Update(dt);
    

    // 更新观察矩阵
    m_BasicEffect.SetViewMatrix(m_pCamera->GetViewMatrixXM());
    m_BasicEffect.SetEyePos(m_pCamera->GetPosition());

    m_SkyboxEffect.SetViewMatrix(m_pCamera->GetViewMatrixXM());

    if (ImGui::Begin("Static Cube Mapping"))
    {
        static int skybox_item = 0;
        static const char* skybox_strs[] = {
            "Daylight",
            "Sunset",
            "Desert",
            "TextSkybox"
        };
        if (ImGui::Combo("Skybox", &skybox_item, skybox_strs, ARRAYSIZE(skybox_strs)))
        {
            Model* pModel = m_ModelManager.GetModel("Skybox");
            switch (skybox_item)
            {
            case 0: 
                m_BasicEffect.SetTextureCube(m_TextureManager.GetTexture("Daylight"));
                pModel->materials[0].Set<std::string>("$Skybox", "Daylight");
                break;
            case 1: 
                m_BasicEffect.SetTextureCube(m_TextureManager.GetTexture("Sunset"));
                pModel->materials[0].Set<std::string>("$Skybox", "Sunset");
                break;
            case 2: 
                m_BasicEffect.SetTextureCube(m_TextureManager.GetTexture("Desert")); 
                pModel->materials[0].Set<std::string>("$Skybox", "Desert");
                break;
                    //新增显示TextSkybox的纹理
            case 3:
                m_BasicEffect.SetTextureCube(m_TextureManager.GetTexture("Text"));
                pModel->materials[0].Set<std::string>("$Skybox", "Text");
                break;
            }
        }
    }
    ImGui::End();
    ImGui::Render();
}
```

效果展示：

![image-20230415170221166](C:\Users\25768\AppData\Roaming\Typora\typora-user-images\image-20230415170221166.png)